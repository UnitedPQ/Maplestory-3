(function(t,i){"use strict";var r=t.ProcessQ=function(t){for(var i in t){this[i]=t[i]}var r=this;this.callRun=function(){r.run()};this.timer={}};r.types={};r.prototype={constructor:r,interval:20,ignoreError:true,delay:0,defalutType:"img",parallel:false,wrapAudio:false,rootPath:null,defaultItemIsFinished:function(){return true},init:function(){this.resultPool={};var t=this.items||[];this.items=[];this.itemCount=0;this.totalWeight=0;for(var i=0,r=t.length;i<r;i++){var e=t[i];this.addItem(e)}if(this.onInit!=null){this.onInit()}},onInit:null,timerStart:function(){var t=this.timer;t.current=Date.now();t.start=t.last=t.current;t.delta=0;t.duration=0},timerTick:function(){var t=this.timer;t.last=t.current;t.current=Date.now();t.delta=t.current-t.last;t.duration+=t.delta},addItem:function(t){var i=t;t={};for(var e in i){t[e]=i[e]}t.options=i;t.src=t.src||t.url;t.id=t.id||t.src||"id_"+(this.items.length+1);var n=t.type||this.defalutType;if(n){t=new r.types[n](t)}if(this.rootPath){if(this.rootPath[this.rootPath.length-1]!="/"){this.rootPath+="/"}}else{this.rootPath=""}if(t.src){if(t.src[0]=="/"){t.src=t.src.substring(1)}t.src=this.rootPath+t.src}t.delay=isNaN(t.delay)?this.delay:Number(t.delay);t.weight=isNaN(t.weight)||t.weight===0?1:Number(t.weight);t.isFinished=t.isFinished||this.defaultItemIsFinished;this.totalWeight+=t.weight;this.items.push(t);this.itemCount++},start:function(){this.paused=false;this.itemIndex=0;this.finishedWeight=0;this.finishedCount=0;this.timerStart();this.activeItem(0);if(this.parallel){this.runParallel()}else{this.run()}},runParallel:function(){var t=this;this.items.forEach(function(i){i.start(t)});var i=this.delay||10;var r=this.items.length;var e={};var n=null;function s(){if(t.finishedCount>=r){t.finish()}else{t.items.forEach(function(i,r){if(!e[r]&&i.isFinished(t)){e[r]=true;t._onItemFinish(i,t)}else if(i.isError&&i.isError(t)){t.onItemError(i,t);if(t.ignoreError){e[r]=true;t.finishedCount+=1;t.finishedWeight+=i.weight}}});var o=t.finishedWeight;if(o!==n){t.onProgressing(i,t);n=o}setTimeout(s,i)}}s()},run:function(){this.mainLoop=setTimeout(this.callRun,this.interval);this.timerTick();var t=this.timer.delta;if(this.paused&&this.onPausing!=null){this.onPausing(t);return}if(!this.currentItem){this.finish();return}this.update(t)},finish:function(){clearTimeout(this.mainLoop);if(this.onFinish!=null){this.onFinish(this)}},onFinish:null,next:function(t){this.activeItem(++this.itemIndex);this.onNext(t,this)},getItem:function(t){return this.items[t]},activeItem:function(t){this.itemIndex=t;this.currentItem=this.getItem(t);if(this.currentItem){this.currentItem._delay=this.currentItem.delay;if(this.currentItem._delay==0){this.currentItem.start(this);this.currentItem._started=true}}},update:function(t){if(t<1){return}if(this.currentItem._delay>=this.interval){this.currentItem._delay-=t}else if(!this.currentItem._started){this.currentItem.start(this);this.currentItem._started=true}if(this.currentItem._started){if(this.currentItem.isFinished(this)){this._onItemFinish(this.currentItem,this);this.next(t)}else if(this.currentItem.isError&&this.currentItem.isError(this)){this.onItemError(this.currentItem,this);if(this.ignoreError){this.finishedCount+=1;this.finishedWeight+=this.currentItem.weight;this.next(t)}}}if(this.currentItem){if(this.currentItem.onProgressing){this.currentItem.onProgressing(t,this)}}this.onProgressing(t,this)},onItemFinish:function(t,i){},_onItemFinish:function(t,i){if(t.onFinish){t.onFinish(i)}if(t.getResult){var r=t.getResult();this.resultPool[t.id]=r}this.finishedCount+=1;this.finishedWeight+=t.weight;this.onItemFinish(t,i)},onItemError:function(t,i){if(t.onError){t.onError(t.errorEvent,i)}t.errorEvent=null},onProgressing:function(t,i){},onNext:function(t,i){}};var e=t.FunctionLoader=function(t){for(var i in t){this[i]=t[i]}};r.types["fn"]=e;e.prototype={constructor:e,id:null,async:false,errorEvent:null,start:function(t){this.finished=true;this.result=this.fn()},getResult:function(){return this.result},onFinish:function(t){},isFinished:function(t){return this.finished},isError:function(t){return this.errorEvent}};var n=t.ImageLoader=function(t){for(var i in t){this[i]=t[i]}};r.types["img"]=n;n.prototype={constructor:n,id:null,src:null,finished:false,async:false,lazy:false,errorEvent:null,start:function(t){if(this.lazy){this.finished=true;return}var i=this.img=new Image;this.finished=this.async;i.loader=this;i.addEventListener("load",this._onload);i.addEventListener("error",this._onerror);i.src=this.src;this.loading=true},_onload:function(t){this.loader.finished=true;this.loader.loading=false;this.removeEventListener("load",this.loader._onload);this.loader.onLoad(this,t);delete this.loader},onLoad:function(t,i){},_onerror:function(t){this.loader.finished=false;this.loader.errorEvent=t;this.removeEventListener("error",this.loader._onerror);this.loader.onError(this,t);delete this.loader},onError:function(t,i){},getResult:function(){if(this.lazy){return this}return this.img},onFinish:function(t){},isFinished:function(t){return this.finished},isError:function(t){return this.errorEvent}};var s=t.AudioLoader=function(t){for(var i in t){this[i]=t[i]}};s.formats={mp3:"audio/mpeg",ogg:"audio/ogg; codecs=vorbis"};r.types["audio"]=s;(function(){var t=new Audio;for(var i in s.formats){if(t.canPlayType(s.formats[i])){s.supportFormat=i;break}}})();s.prototype={constructor:s,id:null,src:null,finished:false,async:false,lazy:false,errorEvent:null,wrap:null,ignoreIOS:true,isIOS:function(){if(typeof window!="undefined"&&window.navigator&&window.navigator.userAgent&&window.navigator.userAgent.toLowerCase){var t=window.navigator.userAgent.toLowerCase();var i=/iphone/.test(t);var r=/ipad/.test(t);var e=/ipod/.test(t);var n=i||r||e;var s=window.location;var o=s&&s.replace&&s.reload;return n&&o}return false},start:function(t){if(this.lazy){this.finished=true;return}this.wrap=this.wrap===null?t.wrapAudio:this.wrap;this.finished=this.async;var i=this.audio=new Audio;if(this.src.indexOf(s.supportFormat)==-1){i.src=this.src+"."+s.supportFormat}else{i.src=this.src}i.loop=this.loop||false;i.preload=true;i.autobuffer=true;if(this.ignoreIOS&&this.isIOS()){this.finished=true;this.wrap=false;this.audio=null;return}i.loader=this;i.addEventListener("canplaythrough",this._onload);i.addEventListener("error",this._onerror);i.load();this.loading=true},_onload:function(t){this.loader.finished=true;this.loader.loading=false;this.removeEventListener("canplaythrough",this.loader._onload);this.loader.onLoad(this,t);delete this.loader},onLoad:function(t,i){},_onerror:function(t){this.loader.finished=false;this.loader.errorEvent=t;this.removeEventListener("error",this.loader._onerror);this.loader.onError(this,t);delete this.loader},onError:function(t,i){},getResult:function(){if(this.lazy){return this}if(typeof Sound!="undefined"&&this.wrap&&!(this.audio instanceof Sound)){var t=this.options||{};t.audio=this.audio;this.audio=new Sound(t)}return this.audio},isFinished:function(t){return this.finished},isError:function(t){return this.errorEvent}}})(this);